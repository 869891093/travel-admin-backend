# 微信云托管原生部署指南

## 问题分析
当前使用CloudBase CLI部署遇到路径问题，建议使用微信云托管原生方式部署。

## 解决方案

### 方法一：使用微信云托管控制台部署

#### 1. 准备部署包
```bash
# 在admin目录下执行
cd miniprogram-5/admin

# 创建部署包
tar -czf admin-deploy.tar.gz --exclude=node_modules --exclude=.git --exclude=*.log .
```

#### 2. 登录微信云托管控制台
- 访问：https://cloud.weixin.qq.com/
- 选择您的云开发环境
- 进入"云托管"服务

#### 3. 创建服务
- 点击"新建服务"
- 服务名称：admin-server
- 选择"自定义镜像"

#### 4. 上传代码
- 上传刚才创建的 `admin-deploy.tar.gz` 文件
- 或者直接上传整个admin目录

#### 5. 配置服务
- **端口**: 3000
- **启动命令**: `npm start`
- **构建命令**: `npm install`
- **环境变量**:
  ```
  NODE_ENV=production
  PORT=3000
  ```

### 方法二：使用Docker镜像部署

#### 1. 构建Docker镜像
```bash
# 在admin目录下
docker build -t admin-server .
```

#### 2. 推送镜像
```bash
# 推送到微信云托管镜像仓库
docker tag admin-server your-registry/admin-server:latest
docker push your-registry/admin-server:latest
```

#### 3. 在控制台部署
- 选择"镜像部署"
- 使用刚才推送的镜像

### 方法三：修复当前CloudBase部署

#### 1. 修改server.js
```javascript
const express = require('express');
const cors = require('cors');
const path = require('path');

const app = express();
const port = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// API路由
app.post('/api/cloud-function', async (req, res) => {
    // ... API逻辑
});

// 静态文件服务
app.use(express.static(path.join(__dirname)));

// SPA路由处理
app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

app.listen(port, '0.0.0.0', () => {
    console.log(`服务器运行在端口 ${port}`);
});
```

#### 2. 修改cloudbaserc.json
```json
{
  "envId": "new-travel-2gy6d6oy7ee5fb0e",
  "framework": {
    "name": "express",
    "plugins": {
      "client": {
        "use": "@cloudbase/framework-plugin-node",
        "inputs": {
          "entry": "server.js",
          "path": "/",
          "name": "admin-server",
          "installCommands": "npm install",
          "startCommands": "npm start",
          "region": "ap-shanghai",
          "platform": "nodejs12.16",
          "containerPort": 3000,
          "minNum": 1,
          "maxNum": 10,
          "cpu": 0.25,
          "mem": 0.5,
          "timeoutSeconds": 30,
          "envVariables": {
            "NODE_ENV": "production",
            "PORT": "3000"
          }
        }
      }
    }
  }
}
```

## 推荐方案
建议使用**方法一（微信云托管控制台部署）**，因为：
1. 更直观，可以直接看到部署状态
2. 更容易调试和排查问题
3. 支持实时日志查看
4. 可以方便地配置域名和HTTPS

## 部署后验证
1. 访问服务地址
2. 检查API接口是否正常
3. 测试管理后台功能
4. 查看服务日志

## 常见问题解决

### Q: 404错误
A: 检查路由配置，确保静态文件路径正确

### Q: 端口问题
A: 确保使用环境变量PORT，并监听0.0.0.0

### Q: 静态文件无法访问
A: 检查express.static配置和文件路径 